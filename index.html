<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta charset="utf-8">
    <meta name="description" content="Webcam-Based Rock Paper Scissors game">
    <meta name="keywords" content="rock-paper-scissors,ai,deep-learning,game,mediapipe,machine-learning,ml,rps">
    <title>Rock Paper Scissors</title>
    <link rel="stylesheet" href="https://acedev003.github.io/assets/css/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
    <link rel="icon" type="image/x-icon" href="https://acedev003.github.io/assets/images/favicon.ico">

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous" type="module"></script>
    <script src="/models/model.js"></script>


    <style>
        html,
        body {
            background-color: #0A0B0D;
        }

        #cam_feed {
            height: 320px;
            width: 320px;
        }

        .w3-card,
        .w3-card-2 {
            box-shadow: 0 2px 5px 0 rgba(121, 191, 36, 0.16), 0 2px 10px 0 rgba(121, 191, 36, 0.12);
        }
        .test{
            text-shadow: 0 2px 5px 0 rgba(121, 191, 36, 0.16), 0 2px 10px 0 rgba(121, 191, 36, 0.12);
        }

    </style>
</head>

<body>
    <div id="alert_modal" class="w3-modal" style="display:block">
        <div class="w3-modal-content w3-transparent">
            <div class="w3-container w3-center">
                <img src="/assets/warning.png" class="w3-image" style="max-height: 120px;">
                <div class="w3-text-white w3-xlarge">
                    Loading AI . .
                </div>
            </div>
        </div>
    </div>

    <div class="w3-container w3-center w3-xxxlarge w3-padding-16" style="color: #81BF24;">
        <span id="rock" class="test">Rock</span> <span id="paper">Paper</span> <span id="scissors">Scissors</span>
    </div>

    <div class="w3-row-padding">

        <div class="w3-container w3-half">
            <div class="w3-card-2 w3-padding w3-margin" style="height: 320px;max-width:400px;float:right">
                <video autoplay="true" id="cam_feed"></video>
            </div>
        </div>

        <div class="w3-container w3-half w3-center">
            <div class="w3-card-2 w3-margin" style="height: 100%;max-width:400px;float:left">
                <img class="w3-image" src="/assets/bot.png" style="max-width: 320px;height:320px">
            </div>
        </div>
        <div class="w3-row w3-center w3-xxlarge w3-text-white">
            <span>0</span>
            <span>-</span>
            <span>0</span>
        </div>
        <div class="w3-row w3-margin w3-padding w3-center w3-large w3-text-gray">
            <button class="w3-button" id="start">Start</button>
        </div>
    </div>
</body>

<script type="module">
    import {
        HandLandmarker,
        FilesetResolver
    } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

    let video        = document.getElementById('cam_feed');
    let loading_warn = document.getElementById('alert_modal');
    let start        = document.getElementById('start');
    let rock         = document.getElementById('rock');
    let paper        = document.getElementById('paper');
    let scissors     = document.getElementById('scissors');
    
    let handLandmarker = undefined;
    let runningMode = "VIDEO";

    let score_human    = 0;
    let score_computer = 0;

    if (navigator.mediaDevices.getUserMedia) 
    {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function (stream) {
                video.srcObject = stream;
            })
            .catch(function (error) {
                console.log("Something went wrong!");
            });
    }

    const createHandLandmarker = async () => {
        const vision = await FilesetResolver.forVisionTasks(
            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
        );

        handLandmarker = await HandLandmarker.createFromOptions(vision, {
            baseOptions: {
                modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                delegate: "GPU"
            },
            runningMode: runningMode,
            numHands: 1
        });
        loading_warn.style.display = 'none';
    };

    createHandLandmarker();

    let get_and_predict = () =>{
        let canvas = document.createElement('canvas');
        
        canvas.height = video.videoHeight;
        canvas.width  = video.videoWidth;

        let ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        let img = new Image();
        img.src = canvas.toDataURL();
        img.crossOrigin = 'anonymous';

        const handLandmarkerResult = handLandmarker.detectForVideo(video,performance.now());
        let features = Array();
        if (handLandmarkerResult.landmarks[0].length < 1) { return; }
        handLandmarkerResult.landmarks[0].forEach(landmark => { features.push(landmark.x,landmark.y) });
        
        let result = predict_rps(
                          features[0], features[1], features[2], features[3], features[4],
                          features[5], features[6], features[7], features[8], features[9],
                          features[10], features[11], features[12], features[13], features[14],
                          features[15], features[16], features[17], features[18], features[19],
                          features[20], features[21], features[22], features[23], features[24],
                          features[25], features[26], features[27], features[28], features[29],
                          features[30], features[31], features[32], features[33], features[34],
                          features[35], features[36], features[37], features[38], features[39],
                          features[40], features[41], features[42]
                    );

        console.log(result);
    };

    let clicked = false;
    start.onclick = () => {
        if (clicked) {return}
        setTimeout(() =>{
            rock.style.boxShadow = '0 2px 5px 0 rgba(121, 191, 36, 0.56), 0 2px 10px 0 rgba(121, 191, 36, 0.22)';
            clicked = true;
            setTimeout(() =>{
                rock.style.boxShadow = '';
                paper.style.boxShadow = '0 2px 5px 0 rgba(121, 191, 36, 0.56), 0 2px 10px 0 rgba(121, 191, 36, 0.22)';
                setTimeout(()=>{
                    paper.style.boxShadow = '';
                    scissors.style.boxShadow = '0 2px 5px 0 rgba(121, 191, 36, 0.56), 0 2px 10px 0 rgba(121, 191, 36, 0.22)';
                    setTimeout(()=>{
                        scissors.style.boxShadow = 'none';
                        get_and_predict();
                        clicked = false;
                    }, 1 * 1000);
                },1 * 1000);
            }, 1 * 1000);
        }, 1 * 1000);
    };

</script>

</html>